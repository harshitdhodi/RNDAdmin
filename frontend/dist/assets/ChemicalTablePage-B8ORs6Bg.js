import{r as l,j as e}from"./react-DKICu8bO.js";import{T as q,a as Y,b as L,c as o,d as J,e as c}from"./table-nX7BFFdz.js";import{g as Ne,D as z,h as ve,B as j,i as G,j as se,k as le,I as V,l as ye,m as Ae,C as ae,n as Le,o as te,p as Te,q as re,r as Fe,s as De,t as ke,v as Ee,w as Me}from"./index-Bbo1zcj1.js";import{S as ie,a as ne,b as oe,c as ce,d as P}from"./select-CnTZk46j.js";import{D as _e,a as Pe,b as Ie,c as Q}from"./dropdown-menu-D0AUj5Dk.js";import{C as de}from"./checkbox-BTLdfW3y.js";import{S as R}from"./sweetalert2-CIewtpap.js";import{R as Be}from"./react-quill-BTfuOY7l.js";import{i as $e,h as me,j as W,k as Re,l as Oe,m as Qe,E as ze,e as Ge,n as Z}from"./lucide-D7hRWJEP.js";import{A as Ve,a as He,b as Ue,c as qe,d as Ye,e as Je,f as We,g as Ke}from"./alert-dialog-D3FD_J_w.js";import{a as ee}from"./axios-DXsv3KKR.js";import{a as Xe,L as Ze}from"./react-router-B9QVkYva.js";import"./classnames-Bv6oJzD9.js";import"./react-dom-BBS6HuAW.js";import"./scheduler-CKyTKYc2.js";import"./react-redux-BrRfTdeB.js";import"./use-sync-external-store-D0ivhzzy.js";import"./@reduxjs-B5J9SSA5.js";import"./redux-DITMfSWq.js";import"./immer-fBqQtvEc.js";import"./redux-thunk-ClJT1hhx.js";import"./reselect-C27TLnWV.js";import"./js-cookie-Cz0CWeBA.js";import"./@radix-ui-BlrBCj0C.js";import"./aria-hidden-DQ5UC2Eg.js";import"./react-remove-scroll-fXbmorz6.js";import"./tslib-CDuPK5Eb.js";import"./react-remove-scroll-bar-C9fmXXva.js";import"./react-style-singleton-DKBZmuKg.js";import"./get-nonce-C-Z93AgS.js";import"./use-sidecar-C10EJNOT.js";import"./use-callback-ref-BoKxM4XI.js";import"./@floating-ui-8J-daYO3.js";import"./class-variance-authority-Dp3B9jqt.js";import"./clsx-B-dksMZM.js";import"./tailwind-merge-D696Ktp4.js";import"./@syncfusion-BIAkhmGL.js";import"./cookie--_YQFYBD.js";import"./lodash-BLBAyiDt.js";import"./quill-BGoone1_.js";const he=({selectedSupplier:D,supplier:m,email:g,name:x,type:i,chemicalName:C})=>{var S,M;console.log("Type:",i),console.log("Supplier Array:",m),console.log("Supplier Email:",(S=m[0])==null?void 0:S.email),console.log("Condition Check:",i==="Customer",m.length>0);const[h,f]=l.useState(""),[w,N]=l.useState(""),[d,v]=l.useState(!1),[p,k]=l.useState(null),{data:T,isLoading:E,error:y}=Ne(),t=(T==null?void 0:T.data)||[],n=i==="Customer"&&Array.isArray(m)&&((M=m[0])!=null&&M.email)?m[0].email:g;console.log("Recipient Email:",n),l.useEffect(()=>{console.log("Supplier updated:",m)},[m]);const A=async()=>{try{v(!0);const u={subject:w,message:h,recipients:Array.isArray(n)?n:[n],chemicalNames:Array.isArray(C)?C:[C]},a=await fetch("/api/chemicalMail/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}),b=await a.json();if(!a.ok)throw new Error(b.message||"Failed to send email");alert("Email sent successfully!"),f(""),N("")}catch(u){console.log("Error sending email:",u),alert("Failed to send email: "+u.message)}finally{v(!1)}},_=u=>{const a=t.find(b=>b._id===u);k(a),f((a==null?void 0:a.body)||""),N((a==null?void 0:a.subject)||"")};return e.jsx("div",{children:e.jsxs(z,{children:[e.jsx(ve,{asChild:!0,children:e.jsxs(j,{variant:"secondary",children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),"Send Email (",D.length,")"]})}),e.jsxs(G,{className:"sm:max-w-[700px] max-h-[90vh] overflow-y-auto",children:[e.jsx(se,{children:e.jsx(le,{children:"Send Email to Selected Suppliers"})}),e.jsxs("div",{className:"grid gap-4 ",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"mb-2 text-sm font-medium",children:"Selected Suppliers"}),e.jsx("div",{className:"p-2 border rounded-lg max-h-[100px] overflow-y-auto",children:n})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"mb-2 text-sm font-medium",children:"Selected Chemicals"}),e.jsx("div",{className:"p-2 border rounded-lg max-h-[100px] overflow-y-auto",children:e.jsx("div",{className:"text-sm py-1",children:C})})]})]}),e.jsxs(ie,{onValueChange:_,children:[e.jsx(ne,{children:e.jsx(oe,{placeholder:"Select email template"})}),e.jsx(ce,{children:E?e.jsx(P,{value:"",disabled:!0,children:"Loading..."}):y?e.jsx(P,{value:"",disabled:!0,children:"Error loading templates"}):t.map(u=>e.jsx(P,{value:u._id,children:u.name},u._id))})]}),e.jsx(V,{placeholder:"Subject",value:w,onChange:u=>N(u.target.value)}),e.jsx("div",{className:"max-h-[300px] overflow-y-auto",children:e.jsx(Be,{value:h,onChange:f,placeholder:"Write your message here...",theme:"snow",className:"bg-white rounded-lg"})}),e.jsx(j,{className:"bg-[#3b1f91] hover:bg-purple-700",onClick:A,disabled:d,children:d?"Sending...":"Send Email"})]})]})]})})},K=({refetch:D,open:m,onClose:g,chemicalName:x,fetchChemicals:i,chemicalId:C,supplier:h,onAddSupplier:f=[]})=>{const[w,N]=l.useState(""),[d,v]=l.useState(null);l.useEffect(()=>{m&&(N(""),v(null))},[m]);const[p,{isLoading:k}]=h==="Supplier"?ye():Ae(),T=Array.isArray(f)?f.filter(t=>{var n;return(n=t.name)==null?void 0:n.toLowerCase().includes(w.toLowerCase())}):[],E=async()=>{if(!d){console.log("No supplier or customer selected");return}try{let t;h==="Supplier"?t=await p({chemical_ids:[x._id],supplierId:d._id}).unwrap():t=await p({chemicalId:[x._id],customerId:d._id}).unwrap(),console.log(`${h} ${d.name} added to ${x.name}`),await D(),i(),g()}catch(t){console.error(`Failed to add ${h.toLowerCase()}:`,t),alert(`Failed to add ${h.toLowerCase()}. Please try again.`)}},y=t=>{v(t),N(t.name)};return e.jsx(z,{open:m,onOpenChange:t=>!t&&g(),children:e.jsxs(G,{className:"max-w-lg p-6",children:[e.jsx(se,{children:e.jsxs(le,{className:"text-lg font-semibold text-[#3b1f91]",children:["Add ",h," for ",x.name]})}),e.jsxs("div",{className:"mt-4",children:[e.jsx(V,{placeholder:`Search ${h}`,value:w,onChange:t=>N(t.target.value),className:"w-full mb-2"}),w&&!d&&e.jsx("div",{className:"bg-white border border-gray-300 rounded shadow max-h-40 overflow-y-auto",children:T.length>0?T.map(t=>e.jsx("div",{onClick:()=>y(t),className:"p-2 cursor-pointer hover:bg-gray-100",children:t.name},t.id)):e.jsxs("div",{className:"p-2 text-gray-500",children:["No matching ",h.toLowerCase(),"s"]})}),e.jsxs("div",{className:"flex justify-between mt-4",children:[e.jsx(j,{onClick:E,className:"bg-[#3b1f91] hover:bg-purple-700",disabled:k||!d,children:k?"Adding...":"+ Add"}),e.jsx(j,{onClick:g,className:"bg-red-600 hover:bg-red-700",children:"Cancel"})]})]})]})})};function es({chemicalName:D,supplier:m,fetchChemicals:g,chemicalId:x}){console.log(x);const[i,C]=l.useState([]),[h,f]=l.useState(!1),[w,N]=l.useState(""),[d,v]=l.useState(""),[p,k]=l.useState(""),[T,E]=l.useState(""),[y,t]=l.useState(null),{selectedItem:n}=l.useContext(ae),{data:A=[],isLoading:_,error:S,refetch:M}=Le(x),{data:u}=te(),[a,{isLoading:b}]=Te(),O=A.filter(r=>r.name.toLowerCase().includes(w.toLowerCase())&&r.email.toLowerCase().includes(d.toLowerCase())&&r.mobile.toLowerCase().includes(p.toLowerCase())&&r.country.toLowerCase().includes(T.toLowerCase())),X=r=>{C(F=>F.includes(r)?F.filter(I=>I!==r):[...F,r])},H=r=>{t(r)},U=async()=>{if(y)try{await a({supplierId:y,chemicalId:x}).unwrap(),M()}catch(r){console.error("Failed to delete chemical:",r),alert("Failed to delete chemical")}t(null)};return e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h1",{className:"text-xl font-semibold text-[#3b1f91]",children:[m," for ",(n==null?void 0:n.name)||"Chemical"]}),e.jsxs(j,{className:"bg-[#3b1f91] hover:bg-purple-700",onClick:()=>f(!0),children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),"Add Supplier"]}),D&&e.jsx(K,{open:h,onClose:()=>f(!1),chemicalName:n||"Unknown Chemical",supplier:"Supplier",onAddSupplier:u,chemicalId:x,refetch:M,fetchChemicals:g})]}),i.length>0&&e.jsx("div",{className:"p-4 border-b",children:e.jsx(he,{selectedSupplier:i,supplier:A,email:A.filter(r=>i.includes(r._id)).map(r=>r.email).join(", "),name:A.filter(r=>i.includes(r._id)).map(r=>r.name).join(", "),chemicalName:n==null?void 0:n.name})}),e.jsxs(q,{children:[e.jsx(Y,{children:e.jsxs(L,{children:[e.jsx(o,{className:"w-12"}),e.jsx(o,{children:"Name"}),e.jsx(o,{children:"Email"}),e.jsx(o,{children:"Mobile"}),e.jsx(o,{children:"Action"})]})}),e.jsxs(J,{children:[_&&e.jsx(L,{children:e.jsx(c,{colSpan:6,className:"text-center py-8",children:"Loading suppliers..."})}),S&&e.jsx(L,{children:e.jsx(c,{colSpan:6,className:"text-center py-8 text-red-500/60",children:"No suppliers available."})}),!_&&!S&&O.map(r=>e.jsxs(L,{children:[e.jsx(c,{children:e.jsx(de,{checked:i.includes(r._id),onCheckedChange:()=>X(r._id)})}),e.jsx(c,{children:r.name}),e.jsx(c,{children:r.email}),e.jsx(c,{children:r.mobile}),e.jsx(c,{children:e.jsx(j,{variant:"ghost",size:"icon",className:"text-red-500 hover:text-red-600",onClick:()=>H(r._id),disabled:b,children:e.jsx(W,{className:"w-4 h-4"})})})]},r._id))]})]}),e.jsx(Ve,{open:!!y,onOpenChange:()=>t(null),children:e.jsxs(He,{children:[e.jsxs(Ue,{children:[e.jsx(qe,{children:"Are you sure?"}),e.jsx(Ye,{children:"This action cannot be undone. This will permanently delete the supplier from this chemical."})]}),e.jsxs(Je,{children:[e.jsx(We,{children:"Cancel"}),e.jsx(Ke,{onClick:U,children:"Delete"})]})]})})]})}function ss({chemicalName:D,supplier:m}){const[g,x]=l.useState([]),{selectedItem:i}=l.useContext(ae),[C,h]=l.useState(!1),[f,w]=l.useState(""),[N,d]=l.useState(""),[v,p]=l.useState(""),[k,T]=l.useState(""),{data:E=[]}=re(),{data:y=[],isLoading:t,error:n,refetch:A}=Fe(i._id),[_]=De(),S=y.filter(a=>a.name.toLowerCase().includes(f.toLowerCase())&&a.email.toLowerCase().includes(N.toLowerCase())&&a.mobile.toLowerCase().includes(v.toLowerCase())&&a.country.toLowerCase().includes(k.toLowerCase())),M=a=>{x(b=>b.includes(a)?b.filter(O=>O!==a):[...b,a])};console.log(g);const u=async a=>{try{await _({customerId:a,chemicalId:i._id})}catch(b){console.error("Failed to remove customer:",b)}};return e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h1",{className:"text-xl font-semibold text-[#3b1f91]",children:[m," for ",i.name]}),e.jsxs(j,{className:"bg-[#3b1f91] hover:bg-purple-700",onClick:()=>h(!0),children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),"Add Customer"]})]}),e.jsx(K,{open:C,onClose:()=>h(!1),chemicalName:i,supplier:"Customer",onAddSupplier:E,refetch:A}),g.length>0&&e.jsx("div",{className:"p-4 border-b",children:e.jsx(he,{selectedSupplier:g,supplier:y,chemicalName:D.name,type:m})}),e.jsxs("div",{className:"border rounded-lg",children:[e.jsxs(q,{children:[e.jsx(Y,{children:e.jsxs(L,{children:[e.jsx(o,{className:"w-12"}),e.jsx(o,{children:"Name"}),e.jsx(o,{children:"Email"}),e.jsx(o,{children:"Mobile"}),e.jsx(o,{children:"Country"}),e.jsx(o,{children:"Action"})]})}),e.jsxs(J,{children:[t&&e.jsx(L,{children:e.jsx(c,{colSpan:6,className:"text-center py-8",children:"Loading customers..."})}),n&&e.jsx(L,{children:e.jsx(c,{colSpan:6,className:"text-center py-8 text-red-500",children:"Error loading customers."})}),!t&&!n&&S.length===0&&e.jsx(L,{children:e.jsx(c,{colSpan:6,className:"text-center py-8 text-muted-foreground",children:"No Data Found"})}),!t&&!n&&S.map(a=>e.jsxs(L,{children:[e.jsx(c,{children:e.jsx(de,{checked:g.includes(a.id),onCheckedChange:()=>M(a.id)})}),e.jsx(c,{children:a.name}),e.jsx(c,{children:a.email}),e.jsx(c,{children:a.mobile}),e.jsx(c,{children:a.country}),e.jsx(c,{children:e.jsx(j,{variant:"ghost",size:"icon",className:"text-red-500 hover:text-red-600",onClick:()=>u(a._id),children:e.jsx(W,{className:"w-4 h-4"})})})]},a.id))]})]}),e.jsxs("div",{className:"flex items-center justify-between border-t p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx("span",{children:"Items per page: 10"}),e.jsxs("span",{children:["1 - ",S.length," of ",S.length]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{variant:"outline",size:"icon",disabled:!0,children:e.jsx(Re,{className:"w-4 h-4"})}),e.jsx(j,{variant:"outline",size:"icon",disabled:!0,children:e.jsx(Oe,{className:"w-4 h-4"})})]})]})]})]})}function zs(){ke();const[D,m]=l.useState(!1),[g,x]=l.useState(!1),[i,C]=l.useState(null),[h,f]=l.useState(""),[w,N]=l.useState(""),[d,v]=l.useState(1),[p,k]=l.useState(20),[T,E]=l.useState(!1);l.useState(null);const[y,t]=l.useState(!1),[n,A]=l.useState(null),[_,S]=l.useState([]),{data:M=[],isLoading:u,error:a}=te(),{data:b=[],isLoading2:O,error2:X}=re();Ee(i==null?void 0:i._id);const H=Xe(),[U,r]=l.useState(0);l.useEffect(()=>{F()},[U]);const F=async()=>{try{const s=await ee.get("/api/chemical/get");S(s.data)}catch(s){console.error("Error fetching chemicals:",s)}},I=_.filter(s=>{const B=s.name||"",$=s.casNumber||"";return B.toLowerCase().includes(h.toLowerCase())&&$.includes(w)}),ue=I.slice((d-1)*p,d*p),xe=()=>{d*p<I.length&&v(s=>s+1)},pe=()=>{d>1&&v(s=>s-1)},je=s=>{k(Number(s)),v(1)},ge=s=>{console.log("Edit",s),H(`/edit-chemical-form/${s._id}`)},Ce=s=>{C(s),E(!0),A("supplier")},fe=s=>{C(s),t(!0),A("customer")},Se=async s=>{try{if((await R.fire({title:"Are you sure?",text:"This action cannot be undone!",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, delete it!",cancelButtonText:"Cancel"})).isConfirmed){const $=await ee.delete(`/api/chemical/delete?id=${s._id}`);if($.data.success||$.data.message==="Chemical deleted successfully")S(be=>be.filter(we=>we._id!==s._id)),await F(),await R.fire({title:"Deleted!",text:"The chemical has been deleted.",icon:"success",timer:2e3,showConfirmButton:!1});else throw new Error($.data.message||"Failed to delete the chemical")}else R.fire({title:"Cancelled",text:"Your chemical is safe!",icon:"info",timer:1500,showConfirmButton:!1})}catch(B){console.error("Error deleting chemical:",B),B.message==="Chemical deleted successfully"?R.fire({title:"Deleted!",text:"The chemical has been deleted.",icon:"success",timer:2e3,showConfirmButton:!1}):R.fire({title:"Error!",text:B.message||"An error occurred while deleting the chemical.",icon:"error",confirmButtonText:"Ok"})}};return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-5",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-lg font-bold text-[#3b1f91]",children:"Chemical List"})}),e.jsx("div",{children:e.jsx(Ze,{to:"/chemical-form",children:e.jsxs(j,{className:"bg-[#3b1f91] hover:bg-[#2a1664]",children:[e.jsx(Qe,{})," Add Chemical"]})})})]}),e.jsx("div",{className:"mb-5",children:e.jsx("hr",{})}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(q,{children:[e.jsxs(Y,{children:[e.jsxs(L,{children:[e.jsx(o,{className:"w-[50px]"}),e.jsx(o,{children:"Name"}),e.jsx(o,{children:"CAS Number"}),e.jsx(o,{children:"Molecular Formula"}),e.jsx(o,{children:"Suppliers"}),e.jsx(o,{children:"Customers"}),e.jsx(o,{children:"Unit Name"})]}),e.jsxs(L,{children:[e.jsx(o,{className:"w-[50px]"}),e.jsx(o,{children:e.jsx(V,{placeholder:"Filter by Name",value:h,onChange:s=>f(s.target.value)})}),e.jsx(o,{children:e.jsx(V,{placeholder:"Filter by CAS Number",value:w,onChange:s=>N(s.target.value)})}),e.jsx(o,{}),e.jsx(o,{}),e.jsx(o,{}),e.jsx(o,{})]})]}),e.jsx(J,{children:ue.map(s=>e.jsxs(L,{children:[e.jsx(c,{children:e.jsxs(_e,{children:[e.jsx(Pe,{asChild:!0,children:e.jsx("button",{className:"p-3",children:e.jsx(ze,{className:"h-4 w-4"})})}),e.jsxs(Ie,{children:[e.jsxs(Q,{onClick:()=>ge(s),children:[e.jsx(Ge,{className:"mr-2 h-4 w-4"}),"Edit"]}),e.jsxs(Q,{onClick:()=>Ce(s),children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),"Add Supplier"]}),e.jsxs(Q,{onClick:()=>fe(s),children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),"Add Customer"]}),e.jsxs(Q,{onClick:()=>Se(s),children:[e.jsx(W,{className:"mr-2 h-4 w-4"}),"Delete"]})]})]})}),e.jsx(c,{children:s.name}),e.jsx(c,{children:s.cas_number}),e.jsx(c,{children:s.molecular_formula}),e.jsx(c,{children:e.jsxs(j,{variant:"default",className:"bg-[#3b1f91] hover:bg-[#3b1f91]",onClick:()=>{C(s),m(!0)},children:["Suppliers (",s.supplierCount,")"]})}),e.jsx(c,{children:e.jsxs(j,{variant:"default",className:"bg-[#3b1f91] hover:bg-[#3b1f91]",onClick:()=>{C(s),x(!0)},children:["Customers(",s.customerCount,")"]})}),e.jsx(c,{children:s.unit})]},s.id))}),i&&e.jsx(K,{open:n==="supplier"?T:y,onClose:()=>{n==="supplier"?E(!1):t(!1),A(null),r(s=>s+1),F()},chemicalName:i.name,supplier:n==="supplier"?"Supplier":"Customer",onAddSupplier:n==="supplier"?M:b,chemicalId:i._id,fetchChemicals:F})]})}),e.jsxs("div",{className:"flex items-center justify-between space-x-2 py-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Items per page:"}),e.jsxs(ie,{defaultValue:p.toString(),onValueChange:je,children:[e.jsx(ne,{className:"w-[70px]",children:e.jsx(oe,{placeholder:p.toString()})}),e.jsxs(ce,{children:[e.jsx(P,{value:"10",children:"10"}),e.jsx(P,{value:"20",children:"20"}),e.jsx(P,{value:"30",children:"30"}),e.jsx(P,{value:"40",children:"40"}),e.jsx(P,{value:"50",children:"50"})]})]}),e.jsx("div",{className:"text-sm font-medium",children:`${(d-1)*p+1} - ${Math.min(d*p,I.length)} of ${I.length}`})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{variant:"outline",size:"icon",onClick:pe,disabled:d===1,children:"<"}),e.jsx(j,{variant:"outline",size:"icon",onClick:xe,disabled:d*p>=I.length,children:">"})]})]}),e.jsx(Me,{selectedItem:i,children:i&&e.jsxs(e.Fragment,{children:[e.jsx(z,{open:D,onOpenChange:m,children:e.jsx(G,{className:"max-w-6xl",children:e.jsx(es,{chemicalName:i,chemicalId:i._id,supplier:"Supplier",fetchChemicals:F})})}),e.jsx(z,{open:g,onOpenChange:x,children:e.jsx(G,{className:"max-w-6xl",children:e.jsx(ss,{selectedItems:i,supplier:"Customer",chemicalName:i,chemicalId:i._id,onUpdate:()=>{F(),r(s=>s+1)}})})})]})})]})}export{zs as default};
